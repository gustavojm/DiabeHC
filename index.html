<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Tabla Carbohidratos</title>

    <link rel="icon" type="image/png" href="/img/favicon.png">

    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/responsive/2.4.0/css/responsive.bootstrap5.min.css" />

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.js"></script>
    <script type="text/javascript"
        src="https://cdn.datatables.net/responsive/2.4.0/js/dataTables.responsive.js"></script>
    <script type="text/javascript"
        src="https://cdn.datatables.net/responsive/2.4.0/js/responsive.bootstrap5.js"></script>

    <script type="text/javascript" src="scripts/papaparse.min.js"></script>

</head>

<body>
    <div class="text-right"><strong>Gramos de HC en medida de consumo habitual</strong></div>

    <p>
        <label for="search_box">Buscar</label>
        <input type="text" placeholder="" id="search_box">
    </p>

</body>

<script>
    $(function () {
        const CSVs = [
            { csv: 'lacteos', name: 'Lácteos', header: '#b8cce4', altRow: 'b8cce4' },
            { csv: 'cereales', name: 'Cereales y derivados, harinas, legumbres y tubérculos', header: '#fde9d9', altRow: '#fde9d9' },
            { csv: 'frutas', name: 'Frutas', header: '#f2dbdb', altRow: '#f2dbdb' },
            { csv: 'hortalizas', name: 'Hortalizas', header: '#ddd9c3', altRow: '#ddd9c3' },
            { csv: 'bebidas', name: 'Bebidas', header: '#c2dfec', altRow: '#c2dfec' },
            { csv: 'dulces', name: 'Dulces', header: '#95B3D7', altRow: '#DCE6F1' },
            { csv: 'frutos', name: 'Fruta grasa y seca', header: '#e5dfec', altRow: '#e5dfec' },
            { csv: 'pastas', name: 'Pastas', header: '#95B3D7', altRow: '#DCE6F1' },
            { csv: 'pasteleria', name: 'Pastelería', header: '#95B3D7', altRow: '#DCE6F1' },
            { csv: 'otros', name: 'Otros', header: '#eddbc9', altRow: '#eddbc9' },

        ]

        // Function to create table structure
        function createTableStructure(category) {
            return `
            <div>
                <h2>
                    <img style="vertical-align:bottom" src="img/${category.csv}.png" alt=""> 
                    &nbsp;<span style="line-height: 80px;">${category.name}</span>
                </h2>
                <div class="table-responsive">
                    <table id="table_${category.csv}" class="table table-bordered hc" style="border-collapse: collapse;">
                        <thead style="background-color:${category.header}; vertical-align:middle; text-align: center; color: white;">
                            <tr>
                                <th rowspan="2">Alimento</th>
                                <th rowspan="2">1 ración de HC son (en gramos)</th>
                                <th colspan="2">¿Cuántos gramos de HC contiene el alimento en su medida habitual de consumo?</th>
                                <th rowspan="2">I.G.</th>
                            </tr>
                            <tr>
                                <th>Medida habitual</th>
                                <th>Gramos de HC en medida habitual</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <style>
                    #table_${category.csv} tbody tr:nth-child(even) {
                        background-color: ${category.altRow} !important;
                    }
                    #table_${category.csv} tbody tr:nth-child(odd) {
                        background-color: white !important;
                    }
                    #table_${category.csv} tbody tr:hover {
                        background-color: ${category.header}33 !important;
                    }
                </style>
            </div>
        `;
        }

        $.each(CSVs, function (index, category) {
            // Create and append the table structure to the page
            const tableHTML = createTableStructure(category);
            $('body').append(tableHTML); // Or append to a specific container like $('#tables-container')

            // Parse CSV file and populate the table
            Papa.parse("tablas/" + category.csv + ".csv", {
                download: true,
                header: false,
                skipEmptyLines: 'greedy',
                complete: function (results) {
                    // Remove header row from data if it exists
                    const data = results.data.slice(1); // Assuming first row is headers

                    $("#table_" + category.csv).DataTable({
                        dom: '<"top"i>rt<"bottom">p<"clear">',
                        responsive: true,
                        data: data,
                        columns: [
                            { title: "Alimento" },
                            { title: "1 ración de HC (g)" },
                            { title: "Medida habitual" },
                            { title: "Gramos de HC en medida habitual" },
                            { title: "I.G." }
                        ],
                        columnDefs: [
                            {
                                "targets": 4, // Glycemic Index column
                                "createdCell": function (td, cellData, rowData, row, col) {
                                    if (cellData == "" || cellData == null) {
                                        $(td).css('background-color', 'white');
                                    } else {
                                        const gi = parseFloat(cellData);
                                        if (gi < 55) {
                                            $(td).css('background-color', '#92d050'); // Green - Low GI
                                        } else if (gi >= 70) {
                                            $(td).css('background-color', '#ff5050'); // Red - High GI
                                        } else {
                                            $(td).css('background-color', '#f3b10d'); // Yellow - Medium GI
                                        }
                                    }
                                }
                            }
                        ]
                    });
                },
                error: function (error) {
                    console.error("Error loading CSV for " + category.csv + ":", error);
                }
            });
        });

        // Global search functionality - initialize after all tables are created
        setTimeout(function () {
            // Store all DataTable instances for global search
            var allTables = [];

            // Collect all DataTable instances
            CSVs.forEach(function (category) {
                var table = $("#table_" + category.csv).DataTable();
                if (table) {
                    allTables.push(table);
                }
            });

            // Global search functionality
            $('#search_box').on('keyup click', function () {
                var searchValue = $(this).val();

                // Search across all tables
                allTables.forEach(function (table) {
                    table.search(searchValue).draw();
                });

                // Hide/show table containers based on filtered results
                allTables.forEach(function (table) {
                    var filteredCount = table.rows({ filter: 'applied' }).count();
                    var tableContainer = $(table.table().container()).closest('div').parent().parent();

                    if (filteredCount === 0 && searchValue.trim() !== '') {
                        tableContainer.hide();
                    } else {
                        tableContainer.show();
                    }
                });
            });

            console.log("Global search initialized for " + allTables.length + " tables");
        }, 1000); // Wait 1 second for all tables to be fully initialized
    });

</script>

</html>